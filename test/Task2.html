<!-- CSE 5542 Lab2 Task2: Energy data - D3 stacked bar chart and line graph -->
<!-- Jiaxin Yang.5039@osu.edu -->

<!DOCTYPE html>
<html>
  <head>
    <title>Lab_2 Task_2</title>
    <!-- <script type="text/javascript" src="d3/d3.min.js"></script>  -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <div id="my_dataviz"></div>
    <style></style>
  </head>

  <body>
    <svg width="3000" height="3000"></svg>

    <script type="text/javascript">
      d3.csv("energy_YEG.csv", StackedBarPlot);
      function StackedBarPlot(error, data_input) {
        var data = [];
        data_input.forEach((each_data) => {
          const i = data.findIndex((e) => e.YEAR === each_data.YEAR);
          if (i > -1) {
            data[i][each_data["ENERGY SOURCE"]] =
              each_data["GENERATION (Megawatthours)"];
          } else {
            let key = "" + each_data["ENERGY SOURCE"];
            let value = each_data["GENERATION (Megawatthours)"];
            let obj = {};
            obj["YEAR"] = each_data.YEAR;
            obj[key] = value;
            data.push(obj);
          }
        });
        console.log(data);

        var margin = { top: 10, right: 30, bottom: 20, left: 50 },
          width = 460 - margin.left - margin.right,
          height = 400 - margin.top - margin.bottom;
        // List of subgroups = header of the csv files = soil condition here

        var subgroups = ["Coal", "Natural Gas", "Nuclear"];
        console.log(subgroups);

        var years = d3
          .map(data, function (d) {
            return d.YEAR;
          })
          .keys();
        console.log(years);

        // append the svg object to the body of the page
        var svg = d3
          .select("#my_dataviz")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        // Add X axis
        var x = d3
          .scaleBand()
          .domain(years)
          .range([0, width])
          .paddingOuter(0.33)
          .paddingInner(0.33);
        svg
          .append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickSizeOuter(0));

        // Add Y axis
        var y = d3.scaleLinear().domain([0, 600000000]).range([height, 0]);
        svg.append("g").call(d3.axisLeft(y));

        // color palette = one color per subgroup
        var color = d3
          .scaleOrdinal()
          .domain(subgroups)
          .range(["#e41a1c", "#377eb8", "#4daf4a"]);

        //stack the data? --> stack per subgroup
        var stackedData = d3.stack().keys(subgroups)(data);
        console.log(stackedData);
        // Show the bars
        svg
          .append("g")
          .selectAll("g")
          // Enter in the stack data = loop key per key = group per group
          .data(stackedData)
          .enter()
          .append("g")
          .attr("fill", function (d) {
            return color(d.key);
          })
          .selectAll("rect")
          // enter a second time = loop subgroup per subgroup to add all rectangles
          .data(function (d) {
            return d;
          })
          .enter()
          .append("rect")
          .attr("x", function (d) {
            return x(d.data.group);
          })
          .attr("y", function (d) {
            return y(d[1]);
          })
          .attr("height", function (d) {
            return y(d[0]) - y(d[1]);
          })
          .attr("width", x.bandwidth());
      }
    </script>
  </body>
</html>
